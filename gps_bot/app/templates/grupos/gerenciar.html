{% extends "base.html" %}

{% block title %}Gerenciar Grupos{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="bi bi-people"></i> Gerenciar Grupos WhatsApp</h4>
            <div>
                <button type="button" class="btn btn-light" onclick="sincronizarGruposAPI()">
                    <i class="bi bi-cloud-download"></i> Sincronizar com API
                </button>
                <button type="button" class="btn btn-info" onclick="sincronizarEstrutura()">
                    <i class="bi bi-diagram-3"></i> Sincronizar Estrutura
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Filtros Avan√ßados -->
        <form method="GET" class="mb-4" id="formFiltros">
            <div class="row g-2">
                <!-- Filtros Simples -->
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm" name="filtro_id"
                           placeholder="Filtrar por ID" value="{{ filtro_id }}">
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" name="filtro_nome"
                           placeholder="Filtrar por Nome" value="{{ filtro_nome }}">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm" name="filtro_cr"
                           placeholder="Filtrar por CR" value="{{ filtro_cr }}">
                </div>

                <!-- Filtros Dropdown -->
                <div class="col-md-2">
                    <select class="form-select form-select-sm" name="diretor_executivo">
                        <option value="">Diretor Executivo</option>
                        {% for opt in filtros_valores.diretor_executivo %}
                        <option value="{{ opt }}" {% if filtro_diretor_executivo==opt %}selected{% endif %}>
                            {{ opt }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" name="diretor_regional">
                        <option value="">Diretor Regional</option>
                        {% for opt in filtros_valores.diretor_regional %}
                        <option value="{{ opt }}" {% if filtro_diretor_regional==opt %}selected{% endif %}>
                            {{ opt }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <select class="form-select form-select-sm" name="gerente_regional">
                        <option value="">Gerente Regional</option>
                        {% for opt in filtros_valores.gerente_regional %}
                        <option value="{{ opt }}" {% if filtro_gerente_regional==opt %}selected{% endif %}>
                            {{ opt }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" name="gerente">
                        <option value="">Gerente</option>
                        {% for opt in filtros_valores.gerente %}
                        <option value="{{ opt }}" {% if filtro_gerente==opt %}selected{% endif %}>
                            {{ opt }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" name="supervisor">
                        <option value="">Supervisor</option>
                        {% for opt in filtros_valores.supervisor %}
                        <option value="{{ opt }}" {% if filtro_supervisor==opt %}selected{% endif %}>
                            {{ opt }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" name="cliente">
                        <option value="">Cliente</option>
                        {% for opt in filtros_valores.cliente %}
                        <option value="{{ opt }}" {% if filtro_cliente==opt %}selected{% endif %}>
                            {{ opt }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <select class="form-select form-select-sm" name="pec_01">
                        <option value="">PEC 01</option>
                        {% for opt in filtros_valores.pec_01 %}
                        <option value="{{ opt }}" {% if filtro_pec_01==opt %}selected{% endif %}>
                            {{ opt }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" name="pec_02">
                        <option value="">PEC 02</option>
                        {% for opt in filtros_valores.pec_02 %}
                        <option value="{{ opt }}" {% if filtro_pec_02==opt %}selected{% endif %}>
                            {{ opt }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Bot√µes -->
                <div class="col-12 mt-2">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="bi bi-search"></i> Filtrar
                    </button>
                    <a href="/grupos/" class="btn btn-secondary btn-sm">
                        <i class="bi bi-x-circle"></i> Limpar Filtros
                    </a>
                    <span class="badge bg-info ms-3">Total: {{ grupos|length }} grupos</span>
                </div>
            </div>
        </form>

        <!-- A√ß√µes em Massa -->
        <div class="mb-3 p-3 bg-light border rounded" id="acoesMassa" style="display:none;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong><span id="countSelecionados">0</span> grupos selecionados</strong>
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-danger" onclick="deletarEmMassa()">
                        <i class="bi bi-trash"></i> Deletar Selecionados
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="desmarcarTodos()">
                        <i class="bi bi-x-circle"></i> Desmarcar Todos
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabela de Grupos -->
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead class="table-dark">
                    <tr>
                        <th style="min-width: 50px;">
                            <input type="checkbox" class="form-check-input" id="selectAll"
                                   onchange="marcarTodosTabela(this)">
                        </th>
                        <th style="min-width: 150px;">ID Grupo</th>
                        <th style="min-width: 200px;">Nome do Grupo</th>
                        <th style="min-width: 80px;">CR</th>
                        <th style="min-width: 120px;">Cliente</th>
                        <th style="min-width: 100px;">PEC 01</th>
                        <th style="min-width: 100px;">PEC 02</th>
                        <th style="min-width: 120px;">Dir. Exec.</th>
                        <th style="min-width: 120px;">Gerente</th>
                        <th style="min-width: 120px;">Supervisor</th>
                        <!-- COLUNAS FIXAS (devem ser as √∫ltimas) -->
                        <th style="min-width: 80px;">Envio</th>
                        <th style="min-width: 120px;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for grupo in grupos %}
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input grupo-checkbox-tabela"
                                   value="{{ grupo[0] }}" onchange="atualizarContadorSelecao()">
                        </td>
                        <td><small><code>{{ grupo[1] }}</code></small></td>
                        <td>{{ grupo[2] }}</td>
                        <td><span class="badge bg-secondary">{{ grupo[4] or '-' }}</span></td>
                        <td><small>{{ grupo[5] or '-' }}</small></td>
                        <td><small>{{ grupo[6] or '-' }}</small></td>
                        <td><small>{{ grupo[7] or '-' }}</small></td>
                        <td><small>{{ grupo[8] or '-' }}</small></td>
                        <td><small>{{ grupo[11] or '-' }}</small></td>
                        <td><small>{{ grupo[12] or '-' }}</small></td>
                        <!-- COLUNAS FIXAS -->
                        <td>
                            <span class="badge bg-{{ 'success' if grupo[3] else 'danger' }}">
                                {{ 'Ativo' if grupo[3] else 'Inativo' }}
                            </span>
                        </td>
                        <td class="text-nowrap">
                            <a href="/grupos/editar/{{ grupo[0] }}" class="btn btn-sm btn-warning" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <button type="button" class="btn btn-sm btn-danger"
                                    onclick="deletarGrupo({{ grupo[0] }}, '{{ grupo[2] }}')" title="Deletar">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="12" class="text-center text-muted">Nenhum grupo encontrado</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal de envio r√°pido continua igual... -->
<!-- (c√≥digo do modal que j√° est√° l√°) -->

<!-- Modal Sincroniza√ß√£o -->
<div class="modal fade" id="modalSincronizar" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-cloud-download"></i> Sincronizar Grupos WhatsApp
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="loadingSync" class="text-center py-5" style="display:none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-3">Buscando grupos novos da API...<br>
                    <small class="text-muted">Isso pode levar at√© 3 minutos. Por favor, aguarde...</small></p>
                </div>
                
                <div id="semGruposNovos" style="display:none;">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> N√£o h√° grupos novos para sincronizar! 
                        Todos os grupos da API j√° est√£o cadastrados no banco.
                    </div>
                </div>
                
                <div id="listaGruposNovos" style="display:none;">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Informa√ß√£o:</strong> Informe o CR (Centro de Resultado) de cada grupo novo.<br>
                        <small>Grupos sem CR ser√£o salvos com <strong>Envio = Inativo</strong> automaticamente.</small>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 45%">Nome do Grupo</th>
                                    <th style="width: 35%">Group ID</th>
                                    <th style="width: 20%">CR (opcional)</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaGruposNovos">
                                <!-- Grupos ser√£o inseridos aqui via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnSalvarGrupos" 
                        onclick="salvarGruposNovos()" style="display:none;">
                    <i class="bi bi-check-circle"></i> Salvar Grupos
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Marcar/desmarcar todos na tabela
function marcarTodosTabela(checkbox) {
    const checkboxes = document.querySelectorAll('.grupo-checkbox-tabela');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    atualizarContadorSelecao();
}

// Desmarcar todos
function desmarcarTodos() {
    document.getElementById('selectAll').checked = false;
    marcarTodosTabela(document.getElementById('selectAll'));
}

// Atualizar contador de selecionados
function atualizarContadorSelecao() {
    const selecionados = document.querySelectorAll('.grupo-checkbox-tabela:checked');
    const count = selecionados.length;

    document.getElementById('countSelecionados').textContent = count;

    // Mostra/esconde barra de a√ß√µes em massa
    if (count > 0) {
        document.getElementById('acoesMassa').style.display = 'block';
    } else {
        document.getElementById('acoesMassa').style.display = 'none';
    }

    // Atualiza checkbox "selecionar todos"
    const total = document.querySelectorAll('.grupo-checkbox-tabela').length;
    document.getElementById('selectAll').checked = count === total && count > 0;
}

// Deletar grupo individual
function deletarGrupo(grupoId, nomeGrupo) {
    if (!confirm(`Tem certeza que deseja deletar o grupo "${nomeGrupo}"?`)) {
        return;
    }

    fetch(`/grupos/deletar/${grupoId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Erro ao deletar grupo');
        }
    })
    .catch(error => {
        alert('Erro: ' + error);
    });
}

// Deletar em massa
function deletarEmMassa() {
    const selecionados = document.querySelectorAll('.grupo-checkbox-tabela:checked');
    const ids = Array.from(selecionados).map(cb => cb.value);

    if (ids.length === 0) {
        alert('Selecione pelo menos um grupo');
        return;
    }

    if (!confirm(`Tem certeza que deseja deletar ${ids.length} grupos selecionados? Esta a√ß√£o n√£o pode ser desfeita!`)) {
        return;
    }

    // Envia requisi√ß√£o para deletar
    fetch('/grupos/deletar-massa', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ ids: ids })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${data.deletados} grupos deletados com sucesso!`);
            location.reload();
        } else {
            alert('Erro: ' + data.error);
        }
    })
    .catch(error => {
        alert('Erro: ' + error);
    });
}

// ==================== SINCRONIZA√á√ÉO COM API ====================
let gruposNovos = [];

function sincronizarGruposAPI() {
    const modal = new bootstrap.Modal(document.getElementById('modalSincronizar'));
    modal.show();
    
    // Mostra loading
    document.getElementById('loadingSync').style.display = 'block';
    document.getElementById('semGruposNovos').style.display = 'none';
    document.getElementById('listaGruposNovos').style.display = 'none';
    document.getElementById('btnSalvarGrupos').style.display = 'none';
    
    fetch('/grupos/sincronizar-api')
        .then(response => response.json())
        .then(data => {
            document.getElementById('loadingSync').style.display = 'none';
            
            if (data.success) {
                gruposNovos = data.grupos_novos;
                
                if (gruposNovos.length === 0) {
                    document.getElementById('semGruposNovos').style.display = 'block';
                } else {
                    mostrarGruposNovos(gruposNovos);
                }
            } else {
                alert('Erro ao sincronizar: ' + data.error);
                modal.hide();
            }
        })
        .catch(error => {
            document.getElementById('loadingSync').style.display = 'none';
            alert('Erro na requisi√ß√£o: ' + error);
            modal.hide();
        });
}

function mostrarGruposNovos(grupos) {
    const tbody = document.getElementById('tabelaGruposNovos');
    tbody.innerHTML = '';
    
    grupos.forEach((grupo, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${grupo.nome}</td>
            <td><small><code>${grupo.group_id}</code></small></td>
            <td>
                <input type="text" class="form-control form-control-sm" 
                       id="cr_${index}" placeholder="Ex: 00000" 
                       maxlength="10">
            </td>
        `;
        tbody.appendChild(tr);
    });
    
    document.getElementById('listaGruposNovos').style.display = 'block';
    document.getElementById('btnSalvarGrupos').style.display = 'block';
}

function salvarGruposNovos() {
    try {
        // Coleta CRs informados (opcional)
        const gruposComCR = gruposNovos.map((grupo, index) => {
            const cr = document.getElementById(`cr_${index}`).value.trim();
            return {
                group_id: grupo.group_id,
                nome: grupo.nome,
                cr: cr || null  // Se vazio, envia null
            };
        });
        
        // Desabilita bot√£o durante o envio
        const btn = document.getElementById('btnSalvarGrupos');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Salvando...';
        
        // Envia para o backend
        fetch('/grupos/adicionar-grupos-novos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ grupos: gruposComCR })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let msg = `‚úÖ ${data.inseridos} grupo(s) adicionado(s) com sucesso!`;
                if (data.estrutura_atualizada > 0) {
                    msg += `\nüìä ${data.estrutura_atualizada} grupo(s) com estrutura atualizada.`;
                }
                if (data.erros && data.erros.length > 0) {
                    msg += '\n\nErros:\n' + data.erros.join('\n');
                }
                alert(msg);
                location.reload();
            } else {
                alert('Erro ao salvar: ' + data.error);
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle"></i> Salvar Grupos';
            }
        })
        .catch(error => {
            alert('Erro na requisi√ß√£o: ' + error);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Salvar Grupos';
        });
        
    } catch (e) {
        alert(e.message);
    }
}

// ==================== SINCRONIZA√á√ÉO DE ESTRUTURA ====================
function sincronizarEstrutura() {
    if (!confirm('Deseja sincronizar os dados de Estrutura (Cliente, PEC, Gestores) para todos os grupos com CR? Isso pode demorar alguns minutos.')) {
        return;
    }
    
    const btn = event.target.closest('button');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sincronizando...';
    
    fetch('/grupos/sincronizar-estrutura', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ Sincroniza√ß√£o conclu√≠da!\n\nTotal: ${data.total}\nAtualizados: ${data.atualizados}\nErros: ${data.erros}`);
            location.reload();
        } else {
            alert('Erro: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-diagram-3"></i> Sincronizar Estrutura';
        }
    })
    .catch(error => {
        alert('Erro na requisi√ß√£o: ' + error);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-diagram-3"></i> Sincronizar Estrutura';
    });
}
</script>
{% endblock %}
