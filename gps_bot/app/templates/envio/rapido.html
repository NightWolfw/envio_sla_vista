{% extends "base.html" %}

{% block title %}Envio Rápido{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header bg-warning">
        <h4 class="mb-0"><i class="bi bi-send"></i> Envio Rápido de Mensagem</h4>
    </div>
    <div class="card-body">
        <form id="formEnvioRapido">
            <!-- Mensagem -->
            <div class="mb-3">
                <label class="form-label fw-bold">Mensagem</label>
                <textarea class="form-control" id="mensagem" name="mensagem" rows="5" 
                          placeholder="Digite a mensagem que será enviada..." required></textarea>
                <small class="text-muted">Você pode usar emojis e quebras de linha</small>
            </div>

            <!-- Filtros Avançados -->
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <strong><i class="bi bi-funnel"></i> Filtros Avançados de Grupos</strong>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <!-- Linha 1 -->
                        <div class="col-md-3">
                            <input type="text" class="form-control form-control-sm"
                                   id="filtro_nome" placeholder="Nome do Grupo">
                        </div>
                        <div class="col-md-2">
                            <input type="text" class="form-control form-control-sm"
                                   id="filtro_cr" placeholder="CR">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="filtro_diretor_executivo">
                                <option value="">Diretor Executivo</option>
                                {% for opt in filtros_valores.diretor_executivo %}
                                <option value="{{ opt }}">{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select form-select-sm" id="filtro_diretor_regional">
                                <option value="">Diretor Regional</option>
                                {% for opt in filtros_valores.diretor_regional %}
                                <option value="{{ opt }}">{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Linha 2 -->
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="filtro_gerente_regional">
                                <option value="">Gerente Regional</option>
                                {% for opt in filtros_valores.gerente_regional %}
                                <option value="{{ opt }}">{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="filtro_gerente">
                                <option value="">Gerente</option>
                                {% for opt in filtros_valores.gerente %}
                                <option value="{{ opt }}">{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="filtro_supervisor">
                                <option value="">Supervisor</option>
                                {% for opt in filtros_valores.supervisor %}
                                <option value="{{ opt }}">{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="filtro_cliente">
                                <option value="">Cliente</option>
                                {% for opt in filtros_valores.cliente %}
                                <option value="{{ opt }}">{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Linha 3 -->
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="filtro_pec_01">
                                <option value="">PEC 01</option>
                                {% for opt in filtros_valores.pec_01 %}
                                <option value="{{ opt }}">{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="filtro_pec_02">
                                <option value="">PEC 02</option>
                                {% for opt in filtros_valores.pec_02 %}
                                <option value="{{ opt }}">{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Botões Filtros -->
                        <div class="col-12">
                            <button type="button" class="btn btn-sm btn-info" onclick="aplicarFiltros()">
                                <i class="bi bi-filter"></i> Aplicar Filtros
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="limparFiltros()">
                                <i class="bi bi-x-circle"></i> Limpar Filtros
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seleção de Grupos -->
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label fw-bold mb-0">Selecionar Grupos</label>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="marcar_todos"
                               onchange="marcarTodosGrupos(this)">
                        <label class="form-check-label fw-bold" for="marcar_todos">
                            Marcar Todos Visíveis (<span id="count_visiveis">{{ grupos|length }}</span>)
                        </label>
                    </div>
                </div>
                <div class="grupos-grid">
                    <div class="row">
                        {% for grupo in grupos %}
                        <div class="col-md-6 col-lg-4 mb-2 grupo-item"
                             data-nome="{{ grupo[2]|lower }}"
                             data-cr="{{ grupo[4] or '' }}"
                             data-diretor-exec="{{ grupo[8]|lower if grupo[8] else '' }}"
                             data-diretor-reg="{{ grupo[9]|lower if grupo[9] else '' }}"
                             data-gerente-reg="{{ grupo[10]|lower if grupo[10] else '' }}"
                             data-gerente="{{ grupo[11]|lower if grupo[11] else '' }}"
                             data-supervisor="{{ grupo[12]|lower if grupo[12] else '' }}"
                             data-cliente="{{ grupo[5]|lower if grupo[5] else '' }}"
                             data-pec01="{{ grupo[6]|lower if grupo[6] else '' }}"
                             data-pec02="{{ grupo[7]|lower if grupo[7] else '' }}">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input grupo-checkbox"
                                       name="grupos" value="{{ grupo[1] }}" id="grupo_{{ grupo[0] }}">
                                <label class="form-check-label" for="grupo_{{ grupo[0] }}">
                                    <strong>{{ grupo[2] }}</strong>
                                    {% if grupo[4] %}
                                    <small class="text-muted">(CR: {{ grupo[4] }})</small>
                                    {% endif %}
                                    {% if grupo[5] %}
                                    <br><small class="text-muted">{{ grupo[5] }}</small>
                                    {% endif %}
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <small class="text-muted mt-2 d-block">
                    <strong><span id="count_selecionados">0</span></strong> grupos selecionados de
                    <strong><span id="count_visiveis_rodape">{{ grupos|length }}</span></strong> visíveis
                </small>
            </div>

            <!-- Botões -->
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-warning btn-lg">
                    <i class="bi bi-send"></i> Enviar Agora
                </button>
                <a href="/" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Resultado -->
<div class="modal fade" id="modalResultado" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resultado do Envio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultadoCorpo"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Marcar/desmarcar APENAS grupos visíveis
function marcarTodosGrupos(checkbox) {
    const gruposVisiveis = document.querySelectorAll('.grupo-item:not([style*="display: none"]) .grupo-checkbox');
    gruposVisiveis.forEach(cb => cb.checked = checkbox.checked);
    atualizarContadores();
}

// Aplicar filtros
function aplicarFiltros() {
    const filtros = {
        nome: document.getElementById('filtro_nome').value.toLowerCase(),
        cr: document.getElementById('filtro_cr').value,
        diretorExec: document.getElementById('filtro_diretor_executivo').value.toLowerCase(),
        diretorReg: document.getElementById('filtro_diretor_regional').value.toLowerCase(),
        gerenteReg: document.getElementById('filtro_gerente_regional').value.toLowerCase(),
        gerente: document.getElementById('filtro_gerente').value.toLowerCase(),
        supervisor: document.getElementById('filtro_supervisor').value.toLowerCase(),
        cliente: document.getElementById('filtro_cliente').value.toLowerCase(),
        pec01: document.getElementById('filtro_pec_01').value.toLowerCase(),
        pec02: document.getElementById('filtro_pec_02').value.toLowerCase()
    };

    const grupos = document.querySelectorAll('.grupo-item');
    let visiveis = 0;

    grupos.forEach(grupo => {
        const match =
            (!filtros.nome || grupo.dataset.nome.includes(filtros.nome)) &&
            (!filtros.cr || grupo.dataset.cr.includes(filtros.cr)) &&
            (!filtros.diretorExec || grupo.dataset.diretorExec.includes(filtros.diretorExec)) &&
            (!filtros.diretorReg || grupo.dataset.diretorReg.includes(filtros.diretorReg)) &&
            (!filtros.gerenteReg || grupo.dataset.gerenteReg.includes(filtros.gerenteReg)) &&
            (!filtros.gerente || grupo.dataset.gerente.includes(filtros.gerente)) &&
            (!filtros.supervisor || grupo.dataset.supervisor.includes(filtros.supervisor)) &&
            (!filtros.cliente || grupo.dataset.cliente.includes(filtros.cliente)) &&
            (!filtros.pec01 || grupo.dataset.pec01.includes(filtros.pec01)) &&
            (!filtros.pec02 || grupo.dataset.pec02.includes(filtros.pec02));

        if (match) {
            grupo.style.display = 'block';
            visiveis++;
        } else {
            grupo.style.display = 'none';
            grupo.querySelector('input').checked = false;
        }
    });

    atualizarContadores();
}

// Limpar filtros
function limparFiltros() {
    document.getElementById('filtro_nome').value = '';
    document.getElementById('filtro_cr').value = '';
    document.getElementById('filtro_diretor_executivo').value = '';
    document.getElementById('filtro_diretor_regional').value = '';
    document.getElementById('filtro_gerente_regional').value = '';
    document.getElementById('filtro_gerente').value = '';
    document.getElementById('filtro_supervisor').value = '';
    document.getElementById('filtro_cliente').value = '';
    document.getElementById('filtro_pec_01').value = '';
    document.getElementById('filtro_pec_02').value = '';

    const grupos = document.querySelectorAll('.grupo-item');
    grupos.forEach(grupo => grupo.style.display = 'block');

    atualizarContadores();
}

// Atualizar contadores
function atualizarContadores() {
    const visiveis = document.querySelectorAll('.grupo-item:not([style*="display: none"])').length;
    const selecionados = document.querySelectorAll('.grupo-checkbox:checked').length;

    document.getElementById('count_visiveis').textContent = visiveis;
    document.getElementById('count_visiveis_rodape').textContent = visiveis;
    document.getElementById('count_selecionados').textContent = selecionados;
}

// Atualizar contador ao marcar/desmarcar
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('grupo-checkbox')) {
        atualizarContadores();
    }
});

// Envio via AJAX
document.getElementById('formEnvioRapido').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const btnEnviar = this.querySelector('button[type="submit"]');

    const selecionados = document.querySelectorAll('.grupo-checkbox:checked').length;
    if (selecionados === 0) {
        alert('Selecione pelo menos um grupo!');
        return;
    }

    if (!confirm(`Enviar mensagem para ${selecionados} grupos?`)) {
        return;
    }

    btnEnviar.disabled = true;
    btnEnviar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enviando...';

    fetch('/envio/processar', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarResultado(data);
        } else {
            alert('Erro: ' + data.error);
        }
        btnEnviar.disabled = false;
        btnEnviar.innerHTML = '<i class="bi bi-send"></i> Enviar Agora';
    })
    .catch(error => {
        alert('Erro na requisição: ' + error);
        btnEnviar.disabled = false;
        btnEnviar.innerHTML = '<i class="bi bi-send"></i> Enviar Agora';
    });
});

function mostrarResultado(data) {
    let html = `
        <div class="alert alert-${data.erros > 0 ? 'warning' : 'success'}">
            <h5>${data.erros > 0 ? '⚠️' : '✅'} Envio Concluído!</h5>
            <p>Sucessos: <strong class="text-success">${data.sucessos}</strong> |
               Erros: <strong class="text-danger">${data.erros}</strong></p>
        </div>
        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead class="table-light">
                    <tr><th>Grupo</th><th>Status</th><th>Erro</th></tr>
                </thead>
                <tbody>
    `;

    data.detalhes.forEach(item => {
        const statusClass = item.status === 'SUCESSO' ? 'success' : 'danger';
        html += `
            <tr>
                <td>${item.grupo}</td>
                <td><span class="badge bg-${statusClass}">${item.status}</span></td>
                <td><small>${item.erro || '-'}</small></td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    
    document.getElementById('resultadoCorpo').innerHTML = html;
    const modal = new bootstrap.Modal(document.getElementById('modalResultado'));
    modal.show();
}
</script>
{% endblock %}
